<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RAG Bot</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-start py-10 px-4">
  <div class="bg-white shadow-lg rounded-lg p-6 max-w-xl w-full">
    <h1 class="text-2xl font-bold mb-4 text-center">RAG Bot</h1>

    <!-- Session ID Input -->
    <input type="text" id="sessionId" placeholder="Enter session ID (or leave blank)" class="border p-2 mb-4 w-full">

    <!-- Upload Form -->
    <form id="uploadForm" class="mb-4" enctype="multipart/form-data" method="POST">
      <input type="file" id="fileInput" accept=".pdf,.txt" class="mb-2" required />
      <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Upload Document</button>
    </form>

    <!-- Query Form -->
    <form id="queryForm" class="mb-4">
      <input type="text" id="queryInput" placeholder="Enter your question..." class="border p-2 w-full mb-2" required />
      <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">Ask</button>
    </form>

    <!-- Results -->
    <div id="result" class="mt-6"></div>
  </div>

  <script>
    const uploadForm = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const queryForm = document.getElementById('queryForm');
    const queryInput = document.getElementById('queryInput');
    const resultContent = document.getElementById('result');
    const sessionIdInput = document.getElementById('sessionId');

    // Upload document
    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (fileInput.files.length === 0) {
        resultContent.innerHTML = `<p class="text-red-500">Please select a file to upload.</p>`;
        return;
      }

      const sessionId = sessionIdInput.value.trim() || crypto.randomUUID();
      sessionIdInput.value = sessionId;

      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      formData.append('session_id', sessionId);

      try {
        const response = await fetch('/upload', {
          method: 'POST',
          body: formData,
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText);
        }

        const result = await response.json();
        resultContent.innerHTML = `<p class="text-green-600 font-semibold">${result.message}</p>`;
      } catch (err) {
        console.error('Upload error:', err);
        resultContent.innerHTML = `<p class="text-red-500">Upload failed: ${err.message}</p>`;
      }
    });

    // Query the uploaded document
    queryForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const sessionId = sessionIdInput.value.trim();
      const queryInputText = queryInput.value.trim();

      if (!sessionId) {
        resultContent.innerHTML = `<p class="text-red-500">Please upload a document first or enter a session ID.</p>`;
        return;
      }

      try {
        const response = await fetch('/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question: queryInputText, session_id: sessionId })
        });

        const result = await response.json();

        if (result.error) {
          resultContent.innerHTML = `<p class="text-red-500">${result.error}</p>`;
        } else {
          resultContent.innerHTML = `
            <p><strong>Question:</strong> ${queryInputText}</p>
            <p><strong>Answer:</strong> ${result.answer}</p>
            <p><strong>Session:</strong> ${result.performance?.session_id || sessionId}</p>
            <p><strong>Query Time:</strong> ${result.performance?.query_time?.toFixed(2) || "?"} seconds</p>
          `;
        }
      } catch (err) {
        console.error('Query error:', err);
        resultContent.innerHTML = `<p class="text-red-500">Query failed: ${err.message}</p>`;
      }
    });
  </script>
</body>
</html>
